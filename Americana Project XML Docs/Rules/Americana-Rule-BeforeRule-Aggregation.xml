<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Rule language="beanshell" name="Americana-Rule-BeforeRule-Aggregation" type="WebServiceBeforeOperationRule">
  <Description>The Web Services connector will call this rule before performing ANY defined operation. This rule can be used to add/update values in the endpoint object before performing the operation and/or add persistent values to the application's data.
    (See information about what to return for more information)</Description>
  <ReferencedRules>
    <Reference class="sailpoint.object.Rule" name="Americana-RuleLibrary-Attribute" />
  </ReferencedRules>
  <Signature returnType="Object">
    <Inputs>
      <Argument name="log" type="org.apache.commons.logging.Log">
        <Description>
          The log object associated with the SailPointContext.
        </Description>
      </Argument>
      <Argument name="context" type="sailpoint.api.SailPointContext">
        <Description>
          A sailpoint.api.SailPointContext object that can be used to query the database if necessary.
        </Description>
      </Argument>
      <Argument name="application">
        <Description>The application associated with the operation being processed.</Description>
      </Argument>
      <Argument name="requestEndPoint">
        <Description>The current request information containing the header, body, context url, method type, response attribute map, 
          and response code. This object can be modified directly and returned by the rule to update the endpoint information that is
          used by the current operation.
        </Description>
      </Argument>
      <Argument name="oldResponseMap">
        <Description>Earlier response object </Description>
      </Argument>
      <Argument name="restClient">
        <Description>REST Client Object</Description>
      </Argument>
      <Argument name="provisioningPlan">
        <Description>A ProvisioningPlan object containing the payload of the http request. A provisioning plan has an account request which defines the operation to be performed on the account.
          An account request can contain multiple attribute requests and each attribute request represents an operation on a single account attribute.
        </Description>
      </Argument>
      <Argument name="partition">
        <Description>If applicable, a Partition object with the current aggregation's partitioning information.
        </Description>
      </Argument>
    </Inputs>
    <Returns>
      <Argument name="Map">
        <Description>An updated or unmodified 'requestEndPoint' object. If application object modifications are desired, create a map containing keys 'updatedEndPoint' and 'connectorStateMap' and use it as the return value;
          Within the new map, the 'updatedEndPoint' can be set to an updated or unmodified 'requestEndPoint' object. The 'connectorStateMap' will be saved as persistent values in the application definition.
        </Description>
      </Argument>
    </Returns>
  </Signature>
  <Source>
  import java.io.IOException;
  import java.io.InputStream;
  import java.io.OutputStreamWriter;
  import java.net.HttpURLConnection;
  import java.net.URL;
  import java.util.Scanner;

  import connector.common.JsonUtil;
  import connector.common.Util;
  import sailpoint.tools.Util;
  import sailpoint.connector.webservices.EndPoint;
  import sailpoint.connector.webservices.WebServicesClient;

  import org.apache.log4j.Logger;
  import org.apache.log4j.Level;

  Logger logger = Logger.getLogger("rule.americana.BeforeRule.OracleBPMIDCS");
  String ruleName = "Americana-Rule-BeforeRule-Aggregation";

  String accessToken = getAccessToken();
  if (Util.isNotNullOrEmpty(accessToken)) {
    accessToken = "Bearer "+accessToken;
    requestEndPoint.addHeader("Content-Type","application/json");
    requestEndPoint.addHeader("Authorization",accessToken);
  }

  /***********************************************************

                        Pagination 

  ***********************************************************/

  Map obj = (Map) application.getAttributeValue("transientValues");
  if(null != obj) {
    String offset = obj.get("offset");
    String urlString = (String) requestEndPoint.getFullUrl();
    if(Util.isNotNullOrEmpty(offset)) { 
      URL tempUrl = new URL(urlString);
      String queryString = tempUrl.getQuery();
      if(Util.isNotNullOrEmpty(queryString)) {
        StringBuffer queryParams = new StringBuffer();
        String param = tempUrl.getQuery();
        if (Util.isNotNullOrEmpty(param)) {
          if(param.startsWith("startIndex=")) {
            queryParams.append("startIndex=");
            queryParams.append(offset);
          } else {
            queryParams.append(param);
          }
        }
        urlString = urlString.replace(tempUrl.getQuery(), queryParams.toString());      
      }
    }
    requestEndPoint.setFullUrl(urlString);
  }
  if (logger.isTraceEnabled()) {
    logger.trace("====The requestEndPoint IN [ " +ruleName+ " ] " +requestEndPoint);
  }
  return requestEndPoint;
  </Source>
</Rule>

</sailpoint>