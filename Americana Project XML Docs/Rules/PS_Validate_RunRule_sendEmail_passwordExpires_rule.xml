<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Rule language="beanshell" name="PS_Validate_RunRule_sendEmail_passwordExpires_rule">
  <Description>rule is used to send email reminders 1||7 days before accountExpiry , so that contractors can extend their endDate by quicklink </Description>
  <Source>
  
  import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.Date;
import sailpoint.object.ResourceObject;
import java.io.InputStreamReader;
import java.util.*;
import sailpoint.api.*;
import sailpoint.api.PasswordGenerator;
import sailpoint.api.SailPointContext;
import sailpoint.object.Identity;
import sailpoint.object.ProvisioningPlan.AccountRequest;
import sailpoint.object.ProvisioningPlan.AttributeRequest;
import sailpoint.object.ProvisioningPlan.ObjectOperation;
import sailpoint.object.ProvisioningPlan.Operation;
import sailpoint.object.ProvisioningPlan;
import java.io.BufferedReader;
import java.util.Iterator;
import java.util.concurrent.TimeUnit;
import org.apache.log4j.Logger;
import sailpoint.object.*;
import java.lang.*;
import java.time.format.DateTimeFormatter;
import java.text.ParseException;
import sailpoint.tools.GeneralException;
  import sailpoint.object.Filter;
import sailpoint.object.Identity;
import sailpoint.object.QueryOptions;

Logger log=Logger.getLogger("customRule4");

  
  
  

  
  
  
  
  
 Filter f = Filter.eq("correlated",true);

  QueryOptions qo= new QueryOptions();
  qo.addFilter(f);
				List ids = context.getObjects(Identity.class,qo);
 
  for(Identity id :ids)
  {
    
    
     String idName=id.getName();
     String idemail=id.getAttribute("email");
    
  
    //if(idName.equalsIgnoreCase("Nirmal Chitlangi(Paramount)")){
   if(id!=null){
   
      
       // Identity id=context.getObjectByName(Identity.class,idName);

    List links=id.getLinks();
    
    for(Link link:links)
      
    {
      
      
      
    if(link.getApplicationName().equalsIgnoreCase("AD Contractors")||link.getApplicationName().equalsIgnoreCase("Active Directory"))
    {
      Boolean linkstatus=link.isDisabled();
      
      
      if(!linkstatus)
      {
    String linkname=link.getApplicationName();
    String passwordExpires=id.getAttribute("passwordExpires");
      log.error("on demand......passwordExpires :"+passwordExpires);
    String firstName=id.getAttribute("firstname");
        String lastname=id.getAttribute("lastname");
        
        Identity manager=id.getManager();
      	log.error("manager :"+manager);
      String  managerEmail="";
      if(manager!=null){
         managerEmail=manager.getAttribute("email");
      }
     
	log.error("managerEmail :"+managerEmail);
		String accountName=id.getAttribute("adLogOnName");
        	String idemail=id.getAttribute("email");
      log.error("idemail "+idemail);
    
 

if(passwordExpires!=null)
{

      // List links=newIdentity.getLinks();


  if( passwordExpires!=null &amp;&amp; !passwordExpires.isEmpty() ){



 
  /*Date currentDate=new Date();
  
        SimpleDateFormat dateFormat = new SimpleDateFormat("MM/dd/yyyy hh:mm:ss a");
        Date expirydate = dateFormat.parse(passwordExpires);
    
    	Long accountexpiry = expirydate.getTime();
    log.info("accountexpiry "+accountexpiry);
    Long current=currentDate.getTime();
    
	  diffInDays = (int) ((accountexpiry-current) / (1000*60*60*24)) ;	
	 log.info("diffInDays "+diffInDays);*/
	 
	 
	
LocalDate expiryDate = LocalDate.parse(passwordExpires);
log.info("Expiry date: " + expiryDate);

// Get the current date
LocalDate currentDate = LocalDate.now();
log.info("Current date: " + currentDate);

// Calculate the difference in days
long diffInDays = expiryDate.toEpochDay() - currentDate.toEpochDay();
log.info("Difference in days: " + diffInDays);
  
      List passwordExpires30 = new ArrayList();
     List passwordExpires15 = new ArrayList(); List accountExpires5 = new ArrayList();
    String info="";
    
    if(diffInDays==7){
    log.error("inside workflow difference in days is 30");
      info=idName +","+idemail+","+passwordExpires+","+linkstatus+","+manager.getName()+","+managerEmail+","+linkname;
           passwordExpires30.add(info);
      
    if (!passwordExpires30.isEmpty()) {
       FileWriter writer = new FileWriter("C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\logs\\passwordExpires7.csv", true);
        for (String info : passwordExpires30) {
            writer.write(info + "\n");
        }
        writer.close();
    }
	
        
    }
	if(diffInDays==1)
{
 log.error("inside workflow difference in days is 15");
    info=idName +","+idemail+","+passwordExpires+","+linkstatus+","+manager.getName()+","+managerEmail+","+linkname;
       passwordExpires15.add(info);
     if (!passwordExpires15.isEmpty()) {
       FileWriter writer = new FileWriter("C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\logs\\passwordExpiresApril221.csv", true);
        for (String info : passwordExpires15) {
            writer.write(info + "\n");
        }
        writer.close();
    }

	
        
        
}

		




     
    }
	
    }
      
      
     
      
    }
    }
}
    }
  }
  
  


</Source>
</Rule>

</sailpoint>