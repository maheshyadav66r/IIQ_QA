<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Rule language="beanshell" name="PS_Send_bulk_reminders">
  <Source>
       import org.apache.log4j.Logger;

    import java.io.File;
    import java.util.ArrayList;
    import java.util.List;
    import java.util.Scanner;

  import sailpoint.object.EmailOptions;
import sailpoint.object.EmailTemplate;
  import sailpoint.object.Identity;

  Logger log = Logger.getLogger("customRule4");
  log.debug("PS_SendReminderEmails: **********Start**********");

  List emails = new ArrayList();
  try {
      //Use to send reminder emails to managers who have pending access reviews
      //String filename = "C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\ApplicationFiles\\Certification\\managers_with_pending_reviews.csv";

      //Use to send certification initiation emails to managers for whom access reviews are created
      String filename = "C:\\Program Files\\Apache Software Foundation\\Tomcat 9.0\\managers\\managers.csv";

     // log.debug("PS_SendReminderEmails: Scanning emails...");
Scanner sc = new Scanner(new File(filename));
sc.useDelimiter("\r\n");
while (sc.hasNext()) {
String email = (String) sc.next();
        //log.debug("PS_SendReminderEmails: email: " + email);    
emails.add(email);
}
sc.close();
    //  log.debug("PS_SendReminderEmails: Email scanning complete.");
} catch (Exception e) {
// TODO: handle exception
      log.error("PS_SendReminderEmails: " + e.getMessage());
}
  //log.debug("PS_SendReminderEmails: emails: " + emails);

try {
      log.debug("PS_SendReminderEmails: Sending emails...");
for (Object obj1 : emails) {
String email = (String)obj1;

        log.debug("PS_SendReminderEmails: email/username: " + email);
Identity manager = context.getObjectByName(Identity.class, email);
        //log.debug("PS_SendReminderEmails: manager with that email: " + manager);
if (manager != null) {
String theemail=manager.getAttribute("email");
log.error("theemail...:"+theemail);
String firstname = manager.getFirstname();
String lastname = manager.getLastname();
          //log.debug("PS_SendReminderEmails: manager's firstname: " + firstname);
          //log.debug("PS_SendReminderEmails: manager's lastname: " + lastname);

          //Use to send reminder emails to managers who have pending access reviews
          //String templateName = "PS_REMINDER_MAILS";

          //Use to send certification initiation emails to managers for whom access reviews are created
          String templateName = "PS_work item reminder_Dynamic_cc_final_by rule";

EmailTemplate eTemplate = context.getObjectByName(EmailTemplate.class, templateName);
EmailOptions eOpts = new EmailOptions();
//eOpts.setTo(email);
eOpts.setTo(theemail);
eOpts.setVariable("firstname", firstname);
eOpts.setVariable("lastname", lastname);

context.sendEmailNotification(eTemplate, eOpts);
}
}
      log.debug("PS_SendReminderEmails: Sent emails.");
} catch (Exception e) {
// TODO: handle exception
      log.error("PS_SendReminderEmails: " + e.getMessage());
}
  log.debug("PS_SendReminderEmails: **********End**********");
       
</Source>
</Rule>

</sailpoint>