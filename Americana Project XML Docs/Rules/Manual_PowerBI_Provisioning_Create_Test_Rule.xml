<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Rule language="beanshell" name="Manual_PowerBI_Provisioning_Create_Test_Rule">
  <Source>
import java.util.*;
import sailpoint.api.*;
import sailpoint.object.*;
import java.sql.*;
import java.io.*;
import sailpoint.tools.Util;
import sailpoint.api.Provisioner;
import sailpoint.api.SailPointContext;
import sailpoint.api.SailPointFactory;
import sailpoint.object.IdentityRequest;
import sailpoint.object.ProvisioningProject;
import sailpoint.tools.GeneralException;
import java.io.File;
import java.util.Scanner;
import java.util.ArrayList;
import java.util.List;  

public static List readCSVfnlData(String csvFilePath, int rIndex, int cIndex, String requesterId) {
	List fnlAccess = new ArrayList();
	try {
		File file = new File(csvFilePath);
		Scanner scanner = new Scanner(file);
		for (int i= 0; i &lt; rIndex; i++){
			if(scanner.hasNextLine()){
				scanner.nextLine();
			} else{
				throw new IndexOutOfBoundsException("Row index out of bounds");
			}
		}
		while(scanner.hasNext()){
			String row = scanner.nextLine();
			String[] celldata = row.split(",");
			if(cIndex &lt; celldata.length){
				if (requesterId.equalsIgnoreCase(String.valueOf(celldata[cIndex]))){
					String fnl = celldata[cIndex + 3];
          for(int j= 0; j &lt; fnl.split("!").length; j++) {
            fnlAccess.add(fnl.split("!")[j].trim());
          }
					if(fnlAccess != null)
						break;
				}
			}
		}
	}
	catch (Exception e){
		throw new RuntimeException(e);
	}
	return fnlAccess;
}

  
public static List readCSVStoreData(String csvFilePath, int rIndex, int cIndex, String requesterId){
	List storeAR = new ArrayList();
	try {
		File file = new File(csvFilePath);
		Scanner scanner = new Scanner(file);
		for (int i= 0; i &lt; rIndex; i++){
			if(scanner.hasNextLine()){
				scanner.nextLine();
			} else{
				throw new IndexOutOfBoundsException("Row index out of bounds");
			}
		}
		while(scanner.hasNext()){
			String row = scanner.nextLine();
			String[] celldata = row.split(",");
			if(cIndex &lt; celldata.length){
				if (requesterId.equalsIgnoreCase(String.valueOf(celldata[cIndex]))){
					storeAR.add(celldata[cIndex + 2]);
				}
			}
		}
	}
	catch (Exception e){
		throw new RuntimeException(e);
	}
	return storeAR;
}
  
String csvFilePath="E:\\WorkItemReport\\PowerBIWorkItemDetails-06-May-24.csv";//Do not change this. This is production file path
int rIndex = 1;//Do not change this
int cIndex = 2; //Do not change this
String requesterId = "55034518";  //provide requester Id(id of the user)
//List fnlAccess =  readCSVfnlData(csvFilePath,rIndex,cIndex, requesterId); //call the method to get fnlAccess details from csv
List addGroupList =  readCSVStoreData(csvFilePath,rIndex,cIndex, requesterId); //call the method to get store details from csv  
//return addGroupList.size();
  
String url = "jdbc:sqlserver://americana-server.database.windows.net:1433;database=BI_UserDB";
String username = "BI_UserAccess";
String password = "Biuser!@123#";
Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
Connection connection = DriverManager.getConnection(url, username, password);  

  try{  
      
      List addGroupList = new ArrayList();  
      List fnlAccess = new ArrayList();
      //String idRequest = "0000009333";
      String selectQuery = null; 
      String costCenter = null;
      String userStatus  = "T";  
      String areaID = null;
      String chainIDLocal = null;
      String restNumber = null;
      String compNumber = null;
      String displayName = null;
      String jobTitle = null;
      String empID = null;
      String userName = null; 
      String email = null; 
      String salesFlag = null;
      String plFlag = null;
      String marketingFlag = null;
      int count = 0;
      //IdentityRequest idReqObj = context.getObjectByName(IdentityRequest.class, idRequest);
      userName = "55034518"; //idReqObj.getProvisionedProject().getMasterPlan().getNativeIdentity();  
      //return   userName;
      Identity identity = context.getObjectByName(Identity.class,userName);  
      displayName = (String) identity.getAttribute("displayName");
      jobTitle = (String) identity.getAttribute("jobTitle") == null ? "Not Available" : (String)identity.getAttribute("jobTitle");
      empID = (String)identity.getAttribute("employeeNumber") == null ? "0" : (String)identity.getAttribute("employeeNumber") ;
    email = (String) identity.getAttribute("email");
      //costCenter = (String) identity.getAttribute("COST_CENTER") != null ? (String) identity.getAttribute("COST_CENTER") : "0";  
      //return empID;  
      //ProvisioningPlan.AccountRequest acctReq = (ProvisioningPlan.AccountRequest) idReqObj.getProvisionedProject().getMasterPlan().getAccountRequest("Microsoft Power BI");
      //addGroupList = acctReq.getAttributeRequests("addGroups");
     // email = "npatel@americana-food.com"; //acctReq.getNativeIdentity();
      //return email;  
      //addGroupList = (List) acctReq.getAttributeRequest("addGroups").getValue(context);  
       addGroupList = readCSVStoreData(csvFilePath,rIndex,cIndex, requesterId); 
    
       costCenter = "0";//String.valueOf(acctReq.getAttributeRequest("COST_CENTER").getValue());
      //return  addGroupList; 
      //fnlAccess = (List) acctReq.getAttributeRequest("fnlAccess").getValue(context);  
       fnlAccess = readCSVfnlData(csvFilePath,rIndex,cIndex, requesterId);
     //return fnlAccess;
      for (Object sName : addGroupList){
        String rName = String.valueOf(sName).split("\\|")[0].trim();
        //return rName;
        if (rName.contains("'")){
          rName = rName.replace("'", "''");
        }
      String cDesc = sName.split("\\|")[2].trim();
      selectQuery = "SELECT StoreID, AREA_ID, CHAIN_ID_LOCAL from USERDB.DimRestaurant where COUNTRY_DESC=\'"+ cDesc + "\' and [Restaurant Name]=\'" + rName + "\'";
      Statement st = connection.createStatement();
      ResultSet rs = st.executeQuery(selectQuery);
        while(rs.next()){
          String storeID = rs.getString("StoreID");
          areaID = rs.getString("AREA_ID");
          chainIDLocal = rs.getString("CHAIN_ID_LOCAL");
          if (storeID.length() &gt; 5) {
            restNumber = storeID.substring((storeID.length()-5),(storeID.length()));
            if (storeID.length() == 6) {
              compNumber = storeID.substring(0,1);
            } else if (storeID.length() == 7) {
              compNumber = storeID.substring(0,2);
            }
          }
        }
      //return "CN--"+compNumber+"-RN-"+restNumber+"-CHN-"+chainIDLocal+"-AN-"+areaID;
      salesFlag = fnlAccess.contains("Sales") ? "T" :"F";
      plFlag = fnlAccess.contains("P/L") ? "T" :"F";
      marketingFlag = fnlAccess.contains("Marketing") ? "T" :"F";
      //return salesFlag+"-"+plFlag+"-"+marketingFlag;
      insertQuery = "INSERT INTO USERDB.User_Security VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
      PreparedStatement insertStatement = connection.prepareStatement(insertQuery);
      insertStatement.setString(1, userName+" - "+displayName+" - ("+jobTitle+")");
      insertStatement.setString(2, "A");
      insertStatement.setString(3, "F");
      insertStatement.setString(4,email);
      insertStatement.setInt(5, Integer.parseInt(empID));
      insertStatement.setInt(6, Integer.parseInt(compNumber));
      insertStatement.setInt(7, Integer.parseInt(restNumber));
      insertStatement.setInt(8, Integer.parseInt(chainIDLocal));
      insertStatement.setInt(9, Integer.parseInt(areaID));
      insertStatement.setString(10, "F");
      insertStatement.setString(11, "F");
      insertStatement.setString(12, "F");
      insertStatement.setString(13, salesFlag);
      insertStatement.setString(14, plFlag);
      insertStatement.setString(15, marketingFlag);
      insertStatement.setString(16, "F");
      insertStatement.setString(17, "F");
      insertStatement.setString(18, userName+" - "+jobTitle);
      insertStatement.setInt(19, Integer.parseInt(empID));
      insertStatement.setInt(20, Integer.parseInt(costCenter));
      insertStatement.setString(21, "T");
      int rows = insertStatement.executeUpdate();
      System.out.println("Number of Rows Affected: "+rows);
      
      count = count +rows; 
      }
      System.out.println("Number of Rows Count: "+count);
  } 
  catch (Exception e){
        System.out.println("JDBCApplication Create Error exception: " +e.getMessage());    
  }
	finally{ 
    try
		 { 
       if (connection != null) 
       connection.close(); 
     }
		catch (SQLException e) 
		 { 
       e.printStackTrace(); 
     } 
  }
  
</Source>
</Rule>

</sailpoint>