<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Workflow configForm="Provisioning Workflow Config Form" handler="sailpoint.api.StandardWorkflowHandler" libraries="Identity,BatchRequest" name="Americana_ContractorAdditionalAccessRequest_Workflow" taskType="LCM" type="LCMRegistration">
  <Variable initializer="false" name="transient">
    <Description>
      Set to false to cause workflow-related objects, such as approval
      work items, to be saved in the database even if they are only
      viewed by the person registering.
    </Description>
  </Variable>
  <Variable name="managerEmail" />
  <Variable name="vpnServer" />
  <Variable name="wifiaccess" />
  <Variable input="true" name="batchRequestItemId">
    <Description>
      Used by the batch interface to record back individual request item status. The specific item id for the individual request in the batch file.  
    </Description>
  </Variable>
  <Variable name="birthrightPlan" />
  <Variable name="workItemNotificationTemplate" />
  <Variable name="primaryApprover" />
  <Variable name="secondaryApprover" />
  <Variable name="primaryApproverName" />
  <Variable name="primaryApproverEmail" />
  <Variable name="secondaryApproverName" />
  <Variable name="secondaryApproverEmail" />
  <Variable name="launcher" />
  <Variable input="true" name="httpSession" transient="true" />
  <Variable name="sAMAccountName" />
  <Variable editable="true" initializer="true" name="optimisticProvisioning">
    <Description>
      Set to true to enable optimistic provisioning.  This will cause
      changes to the entitlements compiled from role assignments to be 
      applied immediately to the identity cube rather than waiting
      for the next refresh/reaggregation after the provisioning system
      completes the request.
    </Description>
  </Variable>
  <Variable editable="true" initializer="true" name="foregroundProvisioning">
    <Description>
      Normally provisioning is done in a step that uses the "background"
      option to force the workflow to be suspend and be resumed in a
      background task thread.  This prevents the browser session from
      hanging since provision can sometimes take a long time.  For demos
      and testing it can be better to do this in the foreground so that
      provisioning will have been performed when control is returned to the
      user.  This prevents having to run the Perform Maintenance task to
      see the results of the request.
    </Description>
  </Variable>
  <Variable editable="true" initializer="true" name="doRefresh">
    <Description>
      Set to true to cause an identity refresh after the changes in the plan
      have been provisioned.  This is normally off, you might want this on
      if you want modification of identity or link attributes to result in
      an immediate re-evaluation of assigned and detected roles.
    </Description>
  </Variable>
  <Variable initializer="Normal" input="true" name="workItemPriority">
    <Description>
      The String version of a WorkItem.Priority. This variable is 
      used to set the priority on all of the workitems generated 
      as part of this workflow and also set on the IdentityRequest
      object.
    </Description>
  </Variable>
  <Variable initializer="requester" input="true" name="notificationScheme">
    <Description>
      A string that specifies who should be notified when the request has been complete.
      The value can be null or a csv of one or more of the following options. 

      none or null
      disable notifications

      user 
      Identity that is registering will be notified.

      manager
      The manager of the Identity that is being updated will be notified.

      securityOfficer
      The identity named in the variable securityOfficerName will be notified.
    </Description>
  </Variable>
  <Variable initializer="LCM Requester Notification" input="true" name="requesterEmailTemplate" />
  <Variable initializer="LCM User Notification" input="true" name="userEmailTemplate">
    <Description>
      The email template to use for user notification.
    </Description>
  </Variable>
  <Variable initializer="LCM Registration Manager Notification" input="true" name="managerEmailTemplate">
    <Description>
      The email template to use for manager notification.
    </Description>
  </Variable>
  <Variable initializer="IdentityCreateRequest" input="true" name="flow" />
  <Variable initializer="LCM Registration Security Officer Notification" input="true" name="securityOfficerEmailTemplate">
    <Description>
      The email template to use for security officer notification.
    </Description>
  </Variable>
  <Variable initializer="serial" input="true" name="approvalMode">
    <Description>
      A string that specifies how we should handle the approvals.  

      By default this is serial since most of these request with
      the exception of manager transfers will have only one approver.

      parallel
      Approvals are processed concurrently and there must be consensus,
      we wait for all approvers to approve.  The first approver that
      rejects terminates the entire approval.

      parallelPoll 
      Approvals are processed concurrently but consensus is not required.
      All approvals will be process, we don't stop if there any
      rejections.  

      serial
      Approvals are processed one at a time and there must be consensus.
      The first approver that rejects terminates the entire approval.

      serialPoll
      Approvals are processed in order but consensus is not required.
      All approvals will be processed, we don't stop if there are any
      rejections.  In effect we are "taking a poll" of the approvers.

      any
      Approvals are processed concurrently, the first approver to 
      respond makes the decision for the group.
    </Description>
  </Variable>
  <Variable initializer="securityOfficer" input="true" name="approvalScheme">
    <Description>
      A csv string that specifies how approvals should be generated for 
      the incoming request.

      The value can be any of the values below, combined together but
      are always processed in this order:

      1. manager
      2. securityOfficer

      Any rejected items from previous approvals will be omitted from the  
      next phase of approvers.

      none - disabled approvals

      manager - The manager will get all approvals

      securityOfficer - The identity named in the variable securityOfficerName.
    </Description>
  </Variable>
  <Variable initializer="Americana-ContractorApprover-Notification" input="true" name="approvalEmailTemplate">
    <Description>
      The email template to use for approval notifications.
    </Description>
  </Variable>
  <Variable initializer="Information Security Officer Group" input="true" name="securityOfficerName">
    <Description>
      The name of the identity that will be sent approvals 
      during security officer approvals.
    </Description>
  </Variable>
  <Variable initializer="Information Security Officer Group" input="true" name="fallbackApprover">
    <Description>
      A String that specifies the name of the Identity that will 
      be assigned any approvals where the owner of the approver 
      can't be resolved. Example if the scheme is "owner" and the 
      application doesn't specify and owner.
    </Description>
  </Variable>
  <Variable name="identityModel">
    <Description>
      The identity model that is used to represent the identity being created.
    </Description>
  </Variable>
  <Variable initializer="continue" input="true" name="policyScheme">
    <Description>
      A String that specifies how policy checks effect the overall
      process.

      none - disabled policy checking

      fail -  fail and exit the workflow if any policy violations are found

      continue -  continue if policy violations are found
    </Description>
  </Variable>
  <Variable input="true" name="ticketManagementApplication">
    <Description>
      Name of the application that can handle ticket requests.
      When non-null the Manage Ticket Steps will be visited to open
      tickets during the workflow lifecycle.      
    </Description>
  </Variable>
  <Variable input="true" name="policiesToCheck">
    <Description>
      A List of policies that should be checked. If this list is
      empty all violations will be checked. Used in combination
      with policyScheme.
    </Description>
  </Variable>
  <Variable initializer="LCM" input="true" name="source">
    <Description>
      String version of sailpoint.object.Source to indicate
      where the request originated.  Defaults to LCM.
    </Description>
  </Variable>
  <Variable initializer="false" name="trace">
    <Description>
      Used for debugging this workflow and when set to true trace
      will be sent to stdout.
    </Description>
  </Variable>
  <Variable input="true" name="approverElectronicSignature">
    <Description>
      The name of the electronic signature object that should be used when workitems 
      are completed by the approver.
    </Description>
  </Variable>
  <Variable name="identityName">
    <Description>The name of the identity we're creating.</Description>
  </Variable>
  <Variable name="identityDisplayName">
    <Description>
      The displayName of the identity being updated.
    </Description>
  </Variable>
  <Variable name="confirmationForm">
    <Description>
      A form that gets displayed for confirming the registration.
    </Description>
  </Variable>
  <Variable input="true" name="plan">
    <Description>
      The ProvisioningPlan that gets generated from the form input.
    </Description>
  </Variable>
  <Variable editable="true" initializer="true" name="identityModel">
    <Description>
      The identity model that is used to represent the identity being created.
    </Description>
  </Variable>
  <Variable name="ticketId">
    <Description>
      The id of the ticket that is generated by the ticketingManagementApplication.
      This is typically generated on the "open" call, and then used in subsequent 
      calls.  It is also stored on the IdentityRequest object under the 
      externalTicketId variable. 
    </Description>
  </Variable>
  <Variable name="policyViolations">
    <Description> 
      List of policy violations that were found during our initial policy scan.
      This list is passed into each work item so the approvers can see 
      pending violations.
    </Description>
  </Variable>
  <Variable name="sAMAccountName" />
  <Variable name="license" />
  <Variable name="user" />
  <Variable initializer="ref:currentUserName" input="true" name="requester" />
  <Variable name="fileParameters" />
  <RuleLibraries>
    <Reference class="sailpoint.object.Rule" name="Approval Library" />
    <Reference class="sailpoint.object.Rule" name="LCM Workflow Library" />
    <Reference class="sailpoint.object.Rule" name="Americana_Contractor_Rule_Library" />
  </RuleLibraries>
  <Step icon="Start" name="Start" posX="28" posY="10">
    <Transition to="Initialize" />
  </Step>
  <Step action="call:getIdentityModel" name="Initialize" posX="98" posY="10" resultVariable="identityModel">
    <Description>
      Initialize the data for the identity that we are creating.
    </Description>
    <Transition to="Registration Form" />
  </Step>
  <Step name="InitializeModel123" posX="208" posY="10" resultVariable="appModel">
    <Description>
      Initialize the data in the model.
    </Description>
    <Script>
      <Source>
        import sailpoint.object.*;
        import sailpoint.api.SailPointContext;
        import sailpoint.transformer.IdentityTransformer;
        import java.util.*;
        IdentityTransformer transformer = new IdentityTransformer(context);
        HashMap model = new HashMap();
        model.put(IdentityTransformer.ATTR_TRANSFORMER_CLASS, transformer.getClass().getName());
        model.put(IdentityTransformer.ATTR_TRANSFORMER_OPTIONS, "");
        model.put("mNum","05");
        return model;
      </Source>
    </Script>
    <Transition to="Registration Form" />
  </Step>
  <Step icon="Approval" name="Registration Form" posX="358" posY="10">
    <Approval mode="serial" owner="ref:launcher" return="identityModel">
      <Arg name="workItemType" value="Form" />
      <Arg name="workItemDescription" value="Contractor Additional Access Request Form" />
      <Arg name="workItemForm" value="Americana_ContractorAdditionalAccess_Form" />
      <Arg name="workItemFormBasePath" value="identityModel" />
      <InterceptorScript>
        <Source>

        import sailpoint.workflow.IdentityRequestLibrary;
        import java.util.List;
		import sailpoint.object.Workflow;  
        import sailpoint.object.Attributes;
        import java.util.Date;
        import java.util.Calendar;
          
        if (method != null &amp;&amp; method.equals(Workflow.INTERCEPTOR_OPEN_WORK_ITEM)) {
			if (workflow != null) {
				if (item != null &amp;&amp; context != null) {
					Calendar cal = Calendar.getInstance();
					cal.add(Calendar.MINUTE,15);
          
					item.setExpiration(cal.getTime());
					item.setWakeUpDate(cal.getTime()); 
					context.saveObject(item);
					context.commitTransaction();
				}
			}
			IdentityRequestLibrary.assimilateWorkItemApprovalSetToIdentityRequest(wfcontext, item.getApprovalSet(), false);
        }
        </Source>
      </InterceptorScript>
    </Approval>
    <Description>
      Display the registration form to collect information about the registrant.
    </Description>
    <Transition to="end" when="&quot;Expired&quot;.equals(lastApprovalState) || &quot;Rejected&quot;.equals(lastApprovalState)" />
    <Transition to="Build Confirmation Form" />
  </Step>
  <Step action="call:buildReadOnlyForm" name="Build Confirmation Form" posX="524" posY="10" resultVariable="confirmationForm">
    <Arg name="form" value="Americana_ContractorAdditionalAccess_Form" />
    <Arg name="helpText" value="Additional access request Confirmation Form" />
    <Arg name="nextButtonLabel" value="Next" />
    <Description>
      Create the confirmation form to be displayed.
    </Description>
    <Transition to="Confirmation Form" />
  </Step>
  <Step icon="Approval" name="Confirmation Form" posX="738" posY="10">
    <Approval mode="serial" owner="ref:launcher" return="identityModel">
      <Arg name="workItemType" value="Form" />
      <Arg name="workItemDescription" value="Confirmation form" />
      <Arg name="workItemForm" value="ref:confirmationForm" />
      <Arg name="workItemFormBasePath" value="identityModel" />
    </Approval>
    <Description>
      Display the confirmation form to the registrant.
    </Description>
    <Transition to="Registration Form" when="!approved" />
    <Transition to="File Upload Form" />
  </Step>
  <Step icon="Approval" name="File Upload Form" posX="928" posY="126">
    <Approval mode="serial" owner="ref:launcher" renderer="lcmFileUploadRenderer.xhtml" send="identityModel">
      <Arg name="launcher" value="$(launcher)" />
      <Arg name="workItemDescription" value="Contractor Additional Request: Upload File For $(identityModel.displayName)" />
      <Arg name="workItemRequester" value="$(launcher)" />
      <Arg name="workItemType" value="Generic" />
    </Approval>
    <Description>
      Display the registration form to collect information about the registrant.
    </Description>
    <Transition to="InitializeModel" />
  </Step>
  <Step name="InitializeModel" posX="208" posY="10" resultVariable="appModel">
    <Description>
      Initialize the data in the model.
    </Description>
    <Script>
      <Source>
        import sailpoint.object.*;
        import sailpoint.api.SailPointContext;
        import sailpoint.transformer.IdentityTransformer;
        import java.util.*;
        import java.util.Date;
        import java.text.DateFormat;
        import java.text.SimpleDateFormat;
        log.error("in the step InitializeModel:::::");

        IdentityTransformer transformer = new IdentityTransformer(context);
        HashMap model = new HashMap();
        model.put(IdentityTransformer.ATTR_TRANSFORMER_CLASS, transformer.getClass().getName());
        model.put(IdentityTransformer.ATTR_TRANSFORMER_OPTIONS, "");
        model.put("mNum","05");
        model.put("user",identityModel.get("user"));
        model.put("sAMAccountName",identityModel.get("sAMAccountName"));
        model.put("vpn",identityModel.get("vpn"));
		 model.put("firstname",identityModel.get("firstname"));

        model.put("manager",identityModel.get("manager"));

        model.put("jobTitle",identityModel.get("jobTitle"));

        model.put("department",identityModel.get("department"));

         model.put("lastname",identityModel.get("lastname"));


        model.put("email",identityModel.get("email"));
         model.put("wifiaccess",identityModel.get("wifiaccess"));
        model.put("laptop",identityModel.get("laptop"));
        model.put("license",identityModel.get("license"));
        model.put("vpnServer",identityModel.get("vpnServer"));
        model.put("justification",identityModel.get("justification"));
        model.put("otherJustificationReason",identityModel.get("otherJustificationReason"));
        workflow.put("identityModel",identityModel);
        
        /* Changes added as a part of file upload process */
		WorkflowCase wfCase = wfcontext.getWorkflowCase();
		if(null != wfCase @and null != wfCase.getWorkflow() @and null != wfCase.getWorkflow().getVariables() @and null != wfCase.getWorkflow().getVariables().get("fileParameters")){
			List vars = (List) wfCase.getWorkflow().getVariables().get("fileParameters");
			if(null != vars @and vars.size() &gt; 0){
				Map mapVars = (Map) vars.get(0);
				if(null != mapVars){
					String url = mapVars.get("url");
					String updatedURL = "";
					if(null != url @and !"".equalsIgnoreCase(url)){
						updatedURL = "&lt;a href=\""+url+"\" target=\"_blank\"&gt;View Attachment&lt;/a&gt;";
					}
					String description = mapVars.get("description");
					if(null != updatedURL @and !"".equalsIgnoreCase(updatedURL) @and null != description @and !"".equalsIgnoreCase(description)){
						Map fileDetailsMap = new HashMap();
						fileDetailsMap.put("Attachment",updatedURL);
						fileDetailsMap.put("Description",description);
						if(null != fileDetailsMap @and fileDetailsMap.size() &gt; 0){
							wfcontext.setVariable("fileParameters",fileDetailsMap);	
						}
					}
				}
			}
		}
		/* Changes until above */
        
        log.error("end of initialize step");
        return model;
      </Source>
    </Script>
    <Transition to="Verify" />
  </Step>
  <Step icon="Analysis" name="Verify" posX="904" posY="10">
    <Description>
      This is a place-holder step where verification of the information could
      occur before a creation request is launched.  This could potentially call
      out to an external system to verify some unique information (eg - employeeId)
      before continuing on.
    </Description>
    <Script>
      <Source>
        import sailpoint.object.Identity;
        log.error("requester is:::"+requester);
        // String requester=null;
        String licenses=null;
        log.error("user is::"+identityModel.get("user"));
        Identity managerId=null;
        Identity reqId=null;
        String strManager=null;
        if(requester!=null){
        log.error("req is::"+requester);
        reqId=context.getObjectByName(Identity.class, requester);
        if(reqId!=null){
        // log.eror("req id not null");
        managerId=reqId.getManager();
        if(managerId!=null){
        strManager=managerId.getName();
        log.error("strManager is:::"+strManager);
        wfcontext.setVariable("primaryApprover",strManager);
		if(managerId.getDisplayName()!=null){
        
        wfcontext.setVariable("primaryApproverName",managerId.getDisplayName());
        }
        
        if(managerId.getEmail()!=null){
        
        wfcontext.setVariable("primaryApproverEmail",managerId.getEmail());
        
        }
		
        }
        }else{
        wfcontext.setVariable("primaryApprover","spadmin");
        log.error("entering into else condition");
        }
        }

        String deptHead="37984";
        wfcontext.setVariable("secondaryApprover",deptHead);
		wfcontext.setVariable("secondaryApproverName","Georgios Perdikouris");
         wfcontext.setVariable("secondaryApproverEmail","gperdikouris@americana-food.com");
		
        log.error("primaryApprover is:::"+primaryApprover);
        log.error("secondaryApprover is:::"+secondaryApprover);
        wfcontext.setVariable("identityName",identityModel.get("user"));
        wfcontext.setVariable("sAMAccountName",identityModel.get("sAMAccountName"));
        wfcontext.setVariable("vpnServer",identityModel.get("vpnServer"));
        //  log.error("inside setting sam account name"+sAMAccountName);
        // wfcontext.setVariable("justification",identityModel.get("justification"));
        String id =identityModel.get("user");

        if(id !=null) {


        Identity ide = context.getObjectByName(Identity.class, id);
        if(ide!=null){
         boolean wifiAccess=(identityModel.get("wifiaccess")==null) ? false: identityModel.get("wifiaccess");
         String wiAccess=(wifiAccess)? "On site access":"False";
        String wiiAccess=(wifiAccess)? "True":"False";
        wfcontext.setVariable("wifiaccess",wiAccess);
 ide.setAttribute("wifiaccess",wiiAccess);
        log.error("wifi access:::::"+wiAccess);
        context.saveObject(ide);
        context.commitTransaction();
        
        Identity manager=ide.getManager();
        if(manager!=null){
        String managerEmail = manager.getEmail();
        wfcontext.setVariable("managerEmail",managerEmail);
        }
        }
        }
        boolean vpnlicense=(identityModel.get("vpn")==null) ? false: identityModel.get("vpn");
        boolean laptoplicense=(identityModel.get("laptop")==null) ? false: identityModel.get("laptop");
        boolean emaillicense=(identityModel.get("email")==null) ? false: identityModel.get("email");
        
        log.error("printing licenses:::"+laptoplicense+","+vpnlicense+","+emaillicense);

        String strVpn=(vpnlicense)? "VPN":"";
        String strLaptop=(laptoplicense)? "Laptop":"";
        String strEmail=(emaillicense)? "Email":"";
       

        licenses= strVpn+"-"+strLaptop+"-"+strEmail;
        log.error("liceses are:"+licenses);
        wfcontext.setVariable("license",licenses);

        log.error("inside wfl context variable license::::"+license);

      </Source>
    </Script>
    <Transition to="getCSV" />
  </Step>
  <Step name="getCSV" posX="738" posY="10">
    <Script>
      <Source>
         import org.apache.log4j.Logger;

         String csvData =getCSVFormat(primaryApproverName, primaryApproverEmail, secondaryApproverName, secondaryApproverEmail);
        wfcontext.setVariable("csvData",csvData);
      </Source>
    </Script>
    <Transition to="getCSVdeptHead" />
  </Step>
  <Step name="getCSVdeptHead" posX="738" posY="10">
    <Script>
      <Source>
         import org.apache.log4j.Logger;

         String csvDatadeptHead =getCSVFormatdeptHead(primaryApproverName, primaryApproverEmail, secondaryApproverName, secondaryApproverEmail);
        wfcontext.setVariable("csvDatadeptHead",csvDatadeptHead);
      </Source>
    </Script>
    <Transition to="Show Status Message for Approval" when="approved" />
  </Step>
  <Step name="Show Status Message for Approval" posX="1104" posY="122">
    <Arg name="identityName" value="ref:identityName" />
    <Script>
      <Source>
      /* commenting these as a part of the Form Upload Changes */
		/*
        import javax.faces.application.FacesMessage; 
        import java.util.List;
        List currentMessages = httpSession.getAttribute("sailpoint.web.PageCodeBase.sessionMessages");  
        FacesMessage myMessage = new FacesMessage(FacesMessage.SEVERITY_INFO, "Your request has been submitted successfully.", "This is ignored");  
        List myMessages = new ArrayList();  
        myMessages.add(myMessage);  
        // Overwrite current message list  
        httpSession.setAttribute("sailpoint.web.PageCodeBase.sessionMessages", myMessages); 
		*/
		/* Changes until above */
      </Source>
    </Script>
    <Transition to="IDRInitailize" />
  </Step>
  <Step icon="Default" name="IDRInitailize" posX="138" posY="13">
    <Arg name="identityName" value="ref:identityName" />
    <Arg name="identityDisplayName" value="ref:identityName" />
    <Arg name="optimisticProvisioning" value="ref:optimisticProvisioning" />
    <Arg name="flow" value="AD Contractors Additional Access Approval Status" />
    <Arg name="plan">
      <Script>
        <Source>
          import sailpoint.object.Identity;
          import sailpoint.object.ProvisioningPlan.AccountRequest;
          import sailpoint.object.ProvisioningPlan;
          import sailpoint.api.Provisioner;
          
          Identity idObj =  context.getObjectByName(Identity.class,launcher);
          
          ProvisioningPlan plan = new ProvisioningPlan(); 
          plan.setIdentity(idObj);
          
          AccountRequest accReq = new AccountRequest();
          accReq.setApplication("AD Contractors");
          accReq.setOp(ProvisioningPlan.ObjectOperation.Create);
          accReq.setNativeIdentity(idObj.getName());
          plan.add(accReq);
          return plan;
        </Source>
      </Script>
    </Arg>
    <Return name="identityRequestId" to="identityRequestId" />
    <WorkflowRef>
      <Reference class="sailpoint.object.Workflow" name="Identity Request Initialize" />
    </WorkflowRef>
    <Transition to="Notify User1" />
  </Step>
  <Step action="call:sendEmail" icon="Email" name="Notify User1" posX="1172" posY="184">
    <Arg name="template" value="Americana-ContractorApprover-Additional Access-userNotification1" />
    <Arg name="managerEmail" value="ref:managerEmail" />
    <Arg name="requesterName" value="ref:launcher" />
    <Arg name="secondaryApproverName" value="ref:secondaryApproverName" />
    <Arg name="managerDisplayName" value="ref:managerDisplayName" />
    <Arg name="primaryApproverName" value="ref:primaryApproverName" />
    <Arg name="to" value="script:getEmail(launcher)" />
    <Arg name="primaryApproverEmail" value="ref:primaryApproverEmail" />
    <Arg name="secondaryApproverEmail" value="ref:secondaryApproverEmail" />
    <Arg name="approverName" value="ref:managerDisplayName" />
    <Transition to="line manager approval" />
  </Step>
  <Step icon="Approval" name="line manager approval" posX="738" posY="10">
    <Approval mode="serial" owner="ref:primaryApprover" return="workItem,appModel" send="appModel,secondaryApprover,primaryApprover,primaryApproverName,primaryApproverEmail,secondaryApproverName,secondaryApproverEmail,fileParameters,csvData">
      <Arg name="workItemType" value="Form" />
      <Arg name="workItemDescription">
        <Script>
          <Source>
            String idname= identityModel.get("user");
            return "Contractor Additional Access Request - Manager Approval Form for "+idname;

          </Source>
        </Script>
      </Arg>
      <Arg name="workItemForm" value="Americana_ContractorAdditionalAccess_Approval_Form" />
      <Arg name="workItemFormBasePath" value="appModel" />
      <Arg name="workItemRequester" value="ref:launcher" />
      <Arg name="plan" value="ref:plan" />
      <Arg name="notificationScheme" value="requester" />
      <Arg name="description" value="ref:workItemDescription" />
      <Arg name="workItemNotificationTemplate" value="Americana-ContractorApprover-Notification-AdditionalAccess-ManagerApprover" />
    </Approval>
    <Description>
      Display the confirmation form to the registrant.
    </Description>
    <Transition to="SendRejectionEmail" when="!approved" />
    <Transition to="User Notify 2" when="approved">
      <Script>
        <Source>
          import sailpoint.object.Identity;
          log.error("inside dept head transition");
          log.error("identityName is:::"+identityName);
          String id=identityName;
          String strLicense=null;
        
          log.error("liscenses are::::::"+license);

          // if(id !=null) {


          // Identity ide = context.getObjectByName(Identity.class, id);
          // if(ide!=null){

          // strLicense=ide.getStringAttribute("ContractorLicense");
          if(license !=null &amp;&amp;(license.contains("Laptop") || license.contains("Email"))||identityModel.get("wifiaccess")){
          log.error("inside if loop");
          return true;
          }
        /*  if(identityModel.get("wifiaccess")){
          return true;
          }*/


          return false;
        </Source>
      </Script>
    </Transition>
    <Transition to="SendApprovalEmail" when="approved" />
    <Transition to="SendRejectionEmail" when="!approved" />
  </Step>
  <Step icon="Task" name="SendApprovalEmail">
    <Arg name="managerEmail" value="ref:managerEmail" />
    <Description>
      Add arguments as necessary to enable refresh features.  Typically you only want this
      to correlate roles and possibly provision if we notice new assigned roles.
      Note that provisioning will be done in the Identity Refresh workflow so if there
      are any provisioning forms to display we won't feed them directly to the 
      current user, they'll have to return to the inbox.
    </Description>
    <Script>
      <Source>
        import sailpoint.object.EmailOptions;
        import sailpoint.object.EmailTemplate;
        import sailpoint.object.*;
        log.error("inside send Approval email step");
        String strreg = null;
        try{
        Identity id = context.getObjectByName(Identity.class,identityName);
        if(id!=null){
        strreg = id.getAttribute("country");
        if(strreg!=null){
        List toAddresses=new ArrayList();
        EmailTemplate emailTemplate = context.getObjectByName(EmailTemplate.class, "Americana-ContractorAdditionalAccessRequestEmailTemplate-ApprovalNotification");  
        if (emailTemplate != null) {

        Custom custom=context.getObjectByName(Custom.class,"Americana-Contractor-Attributes");
        if(custom!=null){
        log.error("inside custom not null if");
        String EmailAddress=null;
        Map map=new HashMap();
        map=custom.get("EmailAddress1");
        if(map!=null){
        EmailAddress=map.get(strreg);
        toAddresses.add(EmailAddress);
        }
        }

        HashMap variables = null;
        variables = new HashMap();
        variables.put("launcher", "TEST");
        variables.put("license",license);
        variables.put("wifiaccess",wifiaccess);
        variables.put("identityName",identityName);
         variables.put("primaryApproverName",primaryApproverName);
		variables.put("secondaryApproverName",secondaryApproverName);
		variables.put("secondaryApproverEmail",secondaryApproverEmail);variables.put("primaryApproverEmail",primaryApproverEmail);
        variables.put("secondaryApprover",secondaryApprover);
          variables.put("primaryApprover",primaryApprover);
        EmailOptions ops = new EmailOptions(toAddresses, variables);
        //ops.setCc("ccmailifany");
        context.sendEmailNotification(emailTemplate, ops);
        }
        }
        }
        }
        catch(Exception e){
        log.error("Error while sending Mail"+e);  
        throw new GeneralException(e);
        }


      </Source>
    </Script>
    <Transition to="Create BirthRight Plan" />
  </Step>
  <Step icon="Task" name="SendRejectionEmail">
    <Arg name="managerEmail" value="ref:managerEmail" />
    <Description>
      Add arguments as necessary to enable refresh features.  Typically you only want this
      to correlate roles and possibly provision if we notice new assigned roles.
      Note that provisioning will be done in the Identity Refresh workflow so if there
      are any provisioning forms to display we won't feed them directly to the 
      current user, they'll have to return to the inbox.
    </Description>
    <Script>
      <Source>
        import sailpoint.object.EmailOptions;
        import sailpoint.object.EmailTemplate;
        import sailpoint.object.*;
        log.error("inside send Approval email step");
        String strreg = null;
        String jdate=null;
        try{
        Identity id = context.getObjectByName(Identity.class,identityName);
        if(id!=null){
        jdate=id.getAttribute("JoiningDate");
        strreg = id.getAttribute("country");
        if(strreg!=null){
        List toAddresses=new ArrayList();
        EmailTemplate emailTemplate = context.getObjectByName(EmailTemplate.class, "Americana-ContractorAdditionalAccessRequestEmailTemplate-RejectionNotification");  
        if (emailTemplate != null) {

        Custom custom=context.getObjectByName(Custom.class,"Americana-Contractor-Attributes");
        if(custom!=null){
        log.error("inside custom not null if");
        String EmailAddress=null;
        Map map=new HashMap();
        map=custom.get("EmailAddress");
        if(map!=null){
        EmailAddress=map.get(strreg);
        toAddresses.add(EmailAddress);
        }
        }

        HashMap variables = null;
        variables = new HashMap();
        variables.put("launcher", "TEST");
        variables.put("license",license);
        variables.put("identityName",identityName);
        EmailOptions ops = new EmailOptions(toAddresses, variables);
        //ops.setCc("ccmailifany");
        context.sendEmailNotification(emailTemplate, ops);
        }
        }
        }
        }
        catch(Exception e){
        log.error("Error while sending Mail"+e);  
        throw new GeneralException(e);
        }


      </Source>
    </Script>
    <Transition to="closeIR" />
  </Step>
  <Step action="call:sendEmail" icon="Email" name="User Notify 2" posX="1172" posY="184">
    <Arg name="template" value="Americana-ContractorApprover-Additional Access Request-userNotification2" />
    <Arg name="managerEmail" value="ref:managerEmail" />
    <Arg name="requesterName" value="ref:launcher" />
    <Arg name="secondaryApproverName" value="ref:secondaryApproverName" />
    <Arg name="managerDisplayName" value="ref:managerDisplayName" />
    <Arg name="primaryApproverName" value="ref:primaryApproverName" />
    <Arg name="to" value="script:getEmail(launcher)" />
    <Arg name="primaryApproverEmail" value="ref:primaryApproverEmail" />
    <Arg name="secondaryApproverEmail" value="ref:secondaryApproverEmail" />
    <Arg name="approverName" value="ref:managerDisplayName" />
    <Transition to="Department Head Approval" />
  </Step>
  <Step icon="Approval" name="Department Head Approval" posX="738" posY="10">
    <Approval mode="serial" owner="ref:secondaryApprover" return="workItem,appModel" send="appModel,primaryApprover,secondaryApprover,primaryApproverName,primaryApproverEmail,secondaryApproverName,secondaryApproverEmail,fileParameters,csvDatadeptHead">
      <Arg name="workItemDescription">
        <Script>
          <Source>
            String idname= identityModel.get("user");
            return "Contractor Additional access request - Second Level Approval Form for "+idname;

          </Source>
        </Script>
      </Arg>
      <Arg name="workItemForm" value="Americana_ContractorAdditionalAccess_Second_Level_Approval_Form" />
      <Arg name="workItemFormBasePath" value="appModel" />
      <Arg name="workItemRequester" value="ref:launcher" />
      <Arg name="plan" value="ref:plan" />
      <Arg name="notificationScheme" value="requester" />
      <Arg name="description" value="ref:workItemDescription" />
      <Arg name="workItemNotificationTemplate" value="Americana-ContractorApprover-Notification-AdditionalAccess-DeptHead" />
    </Approval>
    <Description>
      Display the confirmation form to the registrant.
    </Description>
    <Transition to="SendApprovalEmail" when="approved" />
    <Transition to="SendRejectionEmail" when="!approved" />
    <Transition to="closeIR" />
  </Step>
  <Step icon="Task" name="Create BirthRight Plan" posX="103" posY="164" resultVariable="birthrightPlan">
    <Script>
      <Source>
 import sailpoint.object.EmailOptions;
        import sailpoint.object.EmailTemplate;
        import sailpoint.object.*;
        import sailpoint.object.ProvisioningPlan;
        import sailpoint.object.ProvisioningPlan.AccountRequest;
        import sailpoint.object.ProvisioningPlan.AttributeRequest;
        import sailpoint.object.*;
        import sailpoint.api.Provisioner;
        import sailpoint.api.*;
        import sailpoint.object.ProvisioningProject;
        import sailpoint.api.PasswordGenerator;
        import sailpoint.object.PasswordPolicy;
        import sailpoint.tools.Util;
        import sailpoint.object.Identity;
        import sailpoint.api.Provisioner;
        import sailpoint.connector.Connector; 
        import sailpoint.api.ObjectUtil;
        import org.apache.log4j.Logger;
        import sailpoint.object.Link;

        List links = null;  
        String strLicense=null;
        String strWifiaccess=null;

        log.error("inside plan identity name is:"+identityName);
        //  String id=identityName;
        Identity ide =null;
        String SAMAccountName=null;

        String strmail = null;
        String ent=null;
        String entVpn=null;
        String jdate=null;
        if(identityName !=null) {

        ide = context.getObjectByName(Identity.class, identityName);
        jdate = ide.getAttribute("JoiningDate");
        log.error("ide name is"+ide);
        if(ide!=null){
        strLicense=ide.getStringAttribute("ContractorLicense");
        strWifiaccess=ide.getStringAttribute("wifiaccess");
        log.error("string licenses are :::"+strLicense);
        strLicense=strLicense+license;
        ide.setAttribute("ContractorLicense",strLicense);
        log.error("license is:::"+strLicense);
        if(license.contains("Email")){
        ide.setAttribute("gradeCode","E3");
        }
        context.saveObject(ide);
        context.commitTransaction();

        Custom custom = context.getObjectByName(Custom.class,"Americana-Contractor-Attributes");
        if(custom!=null){
        ent=custom.get(ide.getStringAttribute("country"));
        log.error("checking string ent custom:::");
        entVpn=custom.get(ide.getStringAttribute("country")+"_vpn");
        log.error("checking string entVpn custom:::");
        }


        String nativeid = null;

        links = ide.getLinks();
        if(links != null &amp;&amp; links.size()&gt; 0) {

        for(Link link : links) {

        String applicationName = link.getApplicationName();
        if(applicationName != null &amp;&amp;  applicationName.equalsIgnoreCase("AD Contractors")){
        log.error("inside ad loop");
        nativeid = (String)link.getNativeIdentity();
        sAMAccountName = (String)link.getAttribute("sAMAccountName");
        description = link.getAttribute("description");
        }
        }
        }        	        


        ProvisioningPlan plan = new ProvisioningPlan();
        plan.setIdentity(ide);

        AccountRequest acr = new AccountRequest();
        acr.setApplication("AD Contractors");
        acr.setOperation(AccountRequest.Operation.Modify);

        acr.setNativeIdentity(nativeid);
        strmail =sAMAccountName+"@americana-food.com";

        if(strLicense!=null&amp;&amp;( strLicense.contains("Laptop") || strLicense.contains("Email"))){
        log.error("checking for memberof condition");
        // acr.add(new AttributeRequest("memberOf", ProvisioningPlan.Operation.Add,ent));
        acr.add(new AttributeRequest("mail", ProvisioningPlan.Operation.Add,strmail));
        acr.add(new AttributeRequest("userPrincipalName", ProvisioningPlan.Operation.Add,strmail));
        // acr.add(new AttributeRequest("memberOf", ProvisioningPlan.Operation.Add,entDefault));
        log.error("adding member of attribute");
        
        }
        if(strWifiaccess!=null&amp;&amp;( strWifiaccess.equalsIgnoreCase("True") )){
        log.error("inside wifi check");
        acr.add(new AttributeRequest("memberOf", ProvisioningPlan.Operation.Add,ent));
        }
       /* if(strLicense !=null&amp;&amp;entVpn!=null&amp;&amp; strLicense.contains("VPN")){
        acr.add(new AttributeRequest("memberOf", ProvisioningPlan.Operation.Add,entVpn));

        }*/
        
        
        /* Added this change as a part of BPM Approval ID changes */
        String justification = identityModel.get("justification");
        String otherJustificationReason = identityModel.get("otherJustificationReason");
        String newDescription = "";
        
        if(null != justification @and !"".equalsIgnoreCase(justification) @and null != otherJustificationReason @and !"".equalsIgnoreCase(otherJustificationReason)){
        	if("Other".equalsIgnoreCase(justification)){
        		justification = otherJustificationReason;
        	}
        	newDescription = justification;
       	}
        
        
        if(null != description @and !"".equalsIgnoreCase(description) @and null != newDescription @and !"".equalsIgnoreCase(newDescription)){
        	String updatedDescription = newDescription+" || "+description;
        	acr.add(new AttributeRequest("description", ProvisioningPlan.Operation.Set,updatedDescription));
        }else if(null != newDescription @and !"".equalsIgnoreCase(newDescription)){
        	acr.add(new AttributeRequest("description", ProvisioningPlan.Operation.Set,newDescription));
        }
        /* Added the changes until above */
        

 if(vpnServer!=null){
        log.error("vpnserver value is::"+vpnServer);
        List toAddresses=new ArrayList();
        EmailTemplate emailTemplate = context.getObjectByName(EmailTemplate.class, "Americana-ContractorEmailTemplate-VPNAccess");  
        if (emailTemplate != null) {
            try{
                 toAddresses.add("am.infrasupport@americana-food.com");
               log.error("vpnserver value is::::"+vpnServer);
              HashMap variables = null;
              variables = new HashMap();
              variables.put("launcher", "TEST");
       variables.put("JoiningDate",jdate);
        variables.put("vpnServer",vpnServer);
        variables.put("identityName",identityName);
              EmailOptions ops = new EmailOptions(toAddresses, variables);
              //ops.setCc("ccmailifany");
              context.sendEmailNotification(emailTemplate, ops);
            }
            catch(Exception e){
           //   log.error("Error while sending Mail"+e);  
        			throw new GeneralException(e);
            }
        }
        }
        plan.add(acr);
        log.error("plan is:"+plan.toXml());

        log.error("end of the plan");
        return plan;
        }
        }

      </Source>
    </Script>
    <Transition to="Compile BirthRight Project" />
  </Step>
  <Step action="call:compileProvisioningProject" name="Compile BirthRight Project" posX="406" posY="10" resultVariable="birthrightProject">
    <Arg name="requester" value="string:spadmin" />
    <Arg name="identityName" value="ref:identityName" />
    <Arg name="noLocking" value="true" />
    <Arg name="source" value="string:UI" />
    <Arg name="optimisticProvisioning" value="string:true" />
    <Arg name="plan" value="ref:birthrightPlan" />
    <Description>

      Compile the provisioning plan into a provisioning project.

      If you need to pass in provisioner options like "noFiltering"

      or "noRoleDeprovisioning" you must pass them as explicit

      arguments to the call.

      The evaluation options "requester" and "source" are commonly

      set here.

      You can also pass things into the Template and Field scripts by

      defining Args in this step.

    </Description>
    <Transition to="Birthright Provision" />
  </Step>
  <Step action="call:provisionProject" icon="Provision" name="Birthright Provision" posX="682" posY="10">
    <Arg name="noTriggers" value="true" />
    <Arg name="background" value="string:false" />
    <Arg name="project" value="ref:birthrightProject" />
    <Description>Provision the project.</Description>
    <Transition to="Schedule Contractor AzureAD License Assignment Workflow" />
  </Step>
  <Step icon="Task" name="Schedule Contractor AzureAD License Assignment Workflow" posX="50" posY="10">
    <Description>
      Schedule workflow 'Americana-ContractorWorkflow-AzureADLicenseAssignment' to launch after 35 minutes, as Active Directity to Azure Sync job is scheduled for every 30 minutes
    </Description>
    <Script>
      <Source>

        import java.util.Date;

        import sailpoint.api.RequestManager;
        import sailpoint.object.Attributes;
        import sailpoint.object.Identity;
        import sailpoint.object.Request;
        import sailpoint.object.RequestDefinition;
        import sailpoint.object.Workflow;
        import sailpoint.tools.GeneralException;
        import sailpoint.workflow.StandardWorkflowHandler;

        import org.apache.log4j.Logger;
        import org.apache.log4j.Level;


        Logger logger = Logger.getLogger("Americana.ContractorWorkflow.LifecycleEvent.Joiner.Step.ScheduleAzureADLicenseAssignmentWorkflow");
        logger.setLevel(Level.DEBUG);

        logger.debug("Start Step.ScheduleAzureADLicenseAssignmentWorkflow");


        String workflowName = "Americana-ContractorWorkflow-AzureADLicenseAssignment";
        String caseName     = "Run '" + workflowName + "' for: " + identityName;
        String requesterId  = "spadmin";

        Workflow eventWorkflow = context.getObject(Workflow.class, workflowName);
        if (null == eventWorkflow) {
        logger.error("Could not find a workflow named: " + workflowName);
        throw new GeneralException("Invalid worklfow: " + workflowName);
        }

        // Simulate the request being submitted by a user. Default: spadmin.
        Identity id = context.getObjectByName(Identity.class, requesterId);
        if (null == id) {
        logger.error("Could not find a requester Identity: " + requesterId);
        throw new GeneralException("Invalid identity: " + requesterId);
        }

        // Ask the Request Processor to start the workflow 35 minutes from now.
        // Append the time stamp to the workflow case name to ensure it's unique. 
        long launchTime = System.currentTimeMillis() + (35 * 60 * 1000);
        caseName = caseName + "(" + launchTime + ")";

        // Build out a map of arguments to pass to the Request Scheduler.
        Attributes reqArgs = new Attributes();
        reqArgs.put(StandardWorkflowHandler.ARG_REQUEST_DEFINITION, sailpoint.request.WorkflowRequestExecutor.DEFINITION_NAME);
        reqArgs.put(sailpoint.workflow.StandardWorkflowHandler.ARG_WORKFLOW, workflowName);
        reqArgs.put(sailpoint.workflow.StandardWorkflowHandler.ARG_REQUEST_NAME, caseName);
        reqArgs.put( "requestName", caseName );            

        // Build a map of arguments to pass to the Workflow case when it launches.
        Attributes wfArgs = new Attributes();
        wfArgs.put("identityName",    identityName);
        wfArgs.put("workflow",        eventWorkflow.getName());

        reqArgs.putAll(wfArgs);

        // Use the Request Launcher to schedule the workflow reqeust.  This requires
        // a Request object to store the properties of the request item.
        Request req = new Request();
        RequestDefinition reqdef = context.getObject(RequestDefinition.class, "Workflow Request");
        req.setDefinition(reqdef);
        req.setEventDate( new Date( launchTime ) );
        req.setOwner(id);
        req.setName(caseName);
        req.setAttributes( reqdef, reqArgs );

        // Schedule the work flow via the request manager.
        RequestManager.addRequest(context, req);

        logger.debug("End Step.ScheduleAzureADLicenseAssignmentWorkflow");
      </Source>
    </Script>
    <Transition to="closeIR" />
  </Step>
  <Step icon="Default" name="closeIR" posX="289" posY="37">
    <Script>
      <Source>
        import sailpoint.object.*;
        import sailpoint.object.IdentityRequestItem;
        import sailpoint.object.TaskResult;
        import sailpoint.object.ApprovalItem.ProvisioningState;
        import sailpoint.object.WorkflowSummary.ApprovalSummary;

        
        IdentityRequest reqId =  context.getObjectByName(IdentityRequest.class,identityRequestId);
        String taskResultId = reqId.getTaskResultId();
        TaskResult objectByName = context.getObjectById(TaskResult.class,taskResultId);
        Object attribute = objectByName.getAttribute("workflowSummary");
        List apSList = attribute.getInteractions();
        for(ApprovalSummary apS : apSList){
        if(null ==  apS.getState()){
        apS.setEndDate(new Date());
        if(approved){
        apS.setState(sailpoint.object.WorkItem.State.Finished);
        }
        else {
        apS.setState(sailpoint.object.WorkItem.State.Rejected);
        }
        }
        }
        
        List reqItems =  reqId.getItems();
        for(IdentityRequestItem reqItem : reqItems){
        if(approved){
        reqItem.setProvisioningState(sailpoint.object.ApprovalItem.ProvisioningState.Finished);
        reqItem.setApprovalState(sailpoint.object.WorkItem.State.Finished);
        }
        else {
        reqItem.setApprovalState(sailpoint.object.WorkItem.State.Rejected);
        }
        }
        reqId.setApprovalSummaries(attribute.getInteractions());
        reqId.setCompletionStatus(IdentityRequest.CompletionStatus.Success);
        reqId.setExecutionStatus(IdentityRequest.ExecutionStatus.Completed);
        reqId.setState("End");
        context.saveObject(reqId);
        context.commitTransaction();
      </Source>
    </Script>
    <Transition to="end" />
  </Step>
  <Step icon="Stop" name="end" posX="540" posY="10" />
</Workflow>

</sailpoint>