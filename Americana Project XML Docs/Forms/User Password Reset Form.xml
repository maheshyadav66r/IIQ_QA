<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE sailpoint PUBLIC "sailpoint.dtd" "sailpoint.dtd">
<sailpoint>
<Form name="User Password Reset Form" type="Workflow">
  <Attributes>
    <Map>
      <entry key="includeHiddenFields" value="true" />
      <entry key="pageTitle" value="Password Reset" />
    </Map>
  </Attributes>
  <Section label="Verification Required">
    <Field columnSpan="2" displayName="Verification Code" hidden="true" name="vcode" postBack="true" required="true" type="string">
      <Script>
        <Includes>
          <Reference class="sailpoint.object.Rule" name="Americana-SendSMS-Rule" />
        </Includes>
        <Source>
		import org.apache.log4j.Logger;
          import sailpoint.object.Identity;
		   String password = null;  
  String pin=null;
  PasswordPolicy policy = null;
  try{
  if(requester!=null){
  log.error("requester is"+requester);
    policy = context.getObjectByName(PasswordPolicy.class,"Americana-AD-HelpDeskpinverificationPolicy");
    if(policy!=null){

      password = new PasswordGenerator(context).generatePassword(policy);
      // return password;
      if(password!=null){
String response=sendSMS(requester,password);
    return password;    

      }
    }
}
  }catch(Exception e){

  }
  
          
		</Source>
      </Script>
    </Field>
    <Field columnSpan="2" displayName="HelpDesk User Pin" dynamic="true" helpKey="HelpDesk user must enter their verification pin to reset the password" name="pin" required="true" type="secret" value="ref:pin">
      <Script>
        <Source>
          import sailpoint.object.Identity;
          
          if(null != requester){
          	Identity identityObj = context.getObjectByName(Identity.class,requester);
          	if(null != identityObj){
          		String mobileNo =	identityObj.getAttribute("mobile");
          		if(null != mobileNo @and !"".equals(mobileNo)){
          			field.setHelpKey("Please enter the OTP sent to your mobile number: "+mobileNo);
          		}else{
          			field.setDisplaytype("label");
          			field.setDisplayName("Mobile number doesn't exist in the system, Please contact the IAM team.");
         	 		}
          	}
          }
          
        	return field.getValue();
        </Source>
      </Script>
      <ValidationScript>
        <Source>
          import org.apache.log4j.Logger;
          import sailpoint.object.Identity;
          
          if(null != value @and !"".equalsIgnoreCase(value) @and null != form.getField("vcode") @and null != form.getField("vcode").getValue()){
          	if(!value.equals(form.getField("vcode").getValue())){
          		return("Please enter a valid pin ");		
          	}
          }
          return null;
        </Source>
      </ValidationScript>
    </Field>
  </Section>
  <Button action="next" label="Verify" />
  <Button action="cancel" label="Cancel" />
</Form>

</sailpoint>